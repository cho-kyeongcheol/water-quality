{% extends "backend/layout/base.html" %}
{% load static %}
{% block content %}
    <input id='csrf_token' value='{{ csrf_token }}' hidden>
    <div class="container pt-25 debug">
        https://github.com/kotechnia/water-quality/blob/dev-gain/gain_new/input/input.json
        <div class="text-center debug">
            <div>
                <span class="main-title">수질 예측시스템</span>
            </div>
            <div>
                <span class="main-title-sub">Water quality prediction system</span>
            </div>
        </div>
        <!-- ##### MODEL #####-->
        <div class="pd-20 debug">
            <div>
                <div class="title">Model Select</div>
                <div style="display: flex; flex-direction: row; justify-content: space-around; ">
                    <button class="btn btn-light" onclick="select_model('A')">
                        <i class="fas fa-download mr-8"></i>한강(MODEL1)
                    </button>
                    <button class="btn btn-light" onclick="select_model('B')">
                        <i class="fas fa-download mr-8"></i>금강(MODEL2)
                    </button>
                    <button class="btn btn-light" onclick="select_model('C')">
                        <i class="fas fa-download mr-8"></i>영산강(MODEL3)
                    </button>
                    <button class="btn btn-light" onclick="select_model('D')">
                        <i class="fas fa-download mr-8"></i>낙동강(MODEL4)
                    </button>
                </div>
            </div>
        </div>


        {#        {% include "backend/sample_map.html" %}#}
        {#        {% include "backend/new_map.html" %}#}
        {% include "backend/new_map2.html" %}

        {#        {% include "backend/sample_datepicker.html" %}#}
        {% include "backend/sample_table.html" %}
        <div class="pd-20 debug">
            <div style="display: flex; flex-direction: row;">

                <div class="col-5">
                    <div class="title">측정데이터 선택</div>
                    <select id="column_list">
                        <option value="">모델을 먼저 선택해야합니다.</option>
                    </select>
                </div>
                <div>
                    <div class="title">대상 지점</div>
                    <H2 id="target_point"> ads</H2>
                </div>

                <div hidden>
                    <div class="title">Xsls Upload</div>
                    <form method="post" enctype="multipart/form-data" id="fileUploadForms">
                        <input type="file" name="myfiles" multiple>
                        <button type="submit" class="btn btn-light" id="btnSubmits">
                            <i class="fas fa-download mr-8"></i>Upload
                        </button>
                    </form>
                </div>

            </div>
        </div>
        {% include "backend/new_datepicker.html" %}
        <div class="pd-20 debug">
            <div style="display: flex; flex-direction: row; justify-content: space-around; ">
                <form method="post" enctype="multipart/form-data" id="fileUploadForm">
                    <label>측정 DATA 등록</label>
                    <input type="file" name="myfile">
                    <button type="submit" class="btn btn-light" id="btnSubmit">
                        <i class="fas fa-download mr-8"></i>모델 불러오기
                    </button>
                </form>
                <button type="button" class="btn btn-light" onclick="file_download()">
                    <i class="fas fa-chart-line mr-8"></i>샘플 다운로드
                </button>
                <button type="button" class="btn btn-light" onclick="pridict()">
                    <i class="fas fa-chart-line mr-8"></i>예측하기
                </button>
            </div>


        </div>
        <!--
        <div class="pd-20 debug">
            <div class="title">현재 사용중인 모델</div>
            {% if file_list_zip %}재
                <div class="modelname">{{ file_list_zip }}</div>
            {% else %}
                <div class="modelname">현재 모델이 존재하지 않습니다</div>
            {% endif %}
        </div>
        -->
        <!--
        <div class="pd-20 debug">
            <div class="title">기능</div>
            <div class="row">
                <div class="col text-center">
                    <button type="button" class="btn btn-light">
                        <i class="fas fa-theater-masks mr-8"></i>학습하기
                    </button>
                </div>
                <div class="col text-center">
                    <button type="button" onclick="file_download()" class="btn btn-light">
                        <i class="fas fa-upload mr-8"></i>모델 저장
                    </button>
                </div>

                <div class="col text-center">
                    <form method="post" enctype="multipart/form-data" id="fileUploadForm">

                        <input type="file" name="myfile">
                        <button type="submit" class="btn btn-light" id="btnSubmit">
                            <i class="fas fa-download mr-8"></i>모델 불러오기
                        </button>
                    </form>
                </div>

                <div class="col text-center">

                </div>
                <div class="col text-center">
                    <button type="button" class="btn btn-light">
                        <i class="fas fa-chart-line mr-8"></i>예측하기
                    </button>
                </div>
            </div>
        </div>
    -->
        <div class="pd-20 debug">
            <div class="title">예측 수질</div>
            <canvas id="predictWater" width="400" height="100"></canvas>
        </div>

        <div class="pd-20 debug">
            <div class="title">예측 그래프</div>
            <canvas id="predictGraph" width="400" height="100"></canvas>
        </div>

        <div class="pd-20 debug">
            <div class="title">예측 강우량 및 기온</div>
            <canvas id="predictData" width="400" height="100"></canvas>
        </div>


    </div>
{% endblock %}


{% block javascript %}
    <script>
        var model_activate = ''

        function pridict() {
            $.ajax({
                url: "{% url "predict" %}",
                csrfmiddlewaretoken: $("#csrf_token").val(),
                type: "POST",
                dataType: "json"
            }).done(function () {

            })
        };

        function select_model(param) {

            $.ajax({
                url: "{% url "call_model" %}",
                data: {
                    csrfmiddlewaretoken: $("#csrf_token").val(),
                    "param": param
                },
                type: "POST",
                dataType: "json"
            }).done(function (data) {
                model_activate = param
                let map_info = data.web_info.map_info
                $('#column_list').empty();
                for (let i = 0; i < (data.web_info.column).length; i++) {
                    let col_dict = data.web_info.column
                    for (let key in col_dict[i]) {
                        $('#column_list').append("<option value=" + key + ">" + col_dict[i][key] + "</option>")
                    }
                }
                $('#target_point').text(data.web_info.target_point);
                load_map_data(map_info);
            })
        };

        $("#btnSubmit").click(function (event) {
            event.preventDefault();
            var form = $('#fileUploadForm')[0];
            var data = new FormData(form);
            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "{% url "file_upload" %}",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {
                    alert("complete");
                },
                error: function (e) {
                    console.log("ERROR : ", e);
                    alert("fail");
                }
            });

        });
        $("#btnSubmits").click(function (event) {
            event.preventDefault();
            var form = $('#fileUploadForms')[0];
            var data = new FormData(form);

            alert('data', data);
            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "{% url "multi_file_upload" %}",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {
                    alert("complete");
                },
                error: function (e) {
                    console.log("ERROR : ", e);
                    alert("fail");
                }
            });

        });


        function file_download() {
            $.ajax({
                url: "{% url "file_download" %}", // 클라이언트가 요청을 보낼 서버의 URL 주소
                data: {csrfmiddlewaretoken: $("#csrf_token").val()},
                type: "GET"
            }).done(function () {
                alert(333);
            })
        }

        var predictGraph = document.getElementById('predictGraph');
        var _predictGraph = new Chart(predictGraph, {
            type: 'line',
            data: {
                labels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                datasets: [
                    {
                        label: '테스트',
                        data: [0, 0, 2, 0, 1.8, 0, 2, 0, 2, 0, 0, 0, 2.3, 2.4, 2.7, 0],
                        borderColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        lineTension: 0,
                    },
                    {
                        label: '예측',
                        data: [1, -1, 1, 0, 1.5, 0, 1.8, 0, 1.7, 0.3, 0.2, 0.3, 2.1, 2.2, 2.3, 0.1],
                        borderColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        lineTension: 0,
                    },
                ]
            }
        });

        var predictData = document.getElementById('predictData');
        var _predictData = new Chart(predictData, {
            type: 'bar',
            data: {
                labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                datasets: [
                    {
                        label: '강우량',
                        data: [50, 50, 55, 60, 100, 140, 260, 300, 220, 120, 100, 50],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        type: 'bar',
                    },
                    {
                        label: '기온',
                        data: [150, 155, 180, 250, 280, 300, 340, 350, 320, 280, 210, 160],
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                    },
                ]
            }
        });

        var predictWater = document.getElementById('predictWater');
        var _predictWater = new Chart(predictWater, {
            type: 'bar',
            data: {
                labels: ['1일', '2일', '3일', '4일', '5일'],
                datasets: [
                    {
                        label: '좋음 (4.0 이하)',
                        data: [3, 2, 3, 0, 0],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    },
                    {
                        label: '나쁨 (5.0 이상)',
                        data: [0, 0, 0, 8, 9],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: '수질 기준 (BOD mg/l)'
                }
            }
        });


    </script>
{% endblock %}
{% extends "backend/layout/base.html" %}
{% load static %}
{% block content %}
    <input id='csrf_token' value='{{ csrf_token }}' hidden>

    <div class="container pt-25 debug">
        <div id="loading">
            <img id="loading-image" src='../../../media/loading.svg' alt="Loading..."/>

        </div>

        <div class="text-center debug">
            <div>
                <span class="main-title">수질 예측시스템</span>
            </div>
            <div>
                <span class="main-title-sub">Water quality prediction system</span>
            </div>
        </div>
        <!-- ##### MODEL #####-->

        <div class="pd-20 debug">

            <div>
                <div class="title">Model Select</div>
                <div style="display: flex; flex-direction: row; justify-content: space-around; ">
                    <button class="btn btn-light" onclick="select_model('A')">
                        <i class="fas fa-download mr-8"></i>한강(MODEL1)
                    </button>
                    <button class="btn btn-light" onclick="select_model('B')">
                        <i class="fas fa-download mr-8"></i>금강(MODEL2)
                    </button>
                    <button class="btn btn-light" onclick="select_model('C')">
                        <i class="fas fa-download mr-8"></i>영산강(MODEL3)
                    </button>
                    <button class="btn btn-light" onclick="select_model('D')">
                        <i class="fas fa-download mr-8"></i>낙동강(MODEL4)
                    </button>
                </div>
            </div>
        </div>


        {#        {% include "backend/sample_map.html" %}#}
        {#        {% include "backend/new_map.html" %}#}
        {% include "backend/new_map3.html" %}


        {#        {% include "backend/sample_datepicker.html" %}#}
        {% include "backend/sample_table.html" %}
        <div class="pd-20 debug">
            <div style="display: flex; flex-direction: row;">

                <div class="col-5">
                    <div class="title">측정데이터 선택</div>
                    <select id="column_list">
                        <option value="">모델을 먼저 선택해야합니다.</option>
                    </select>
                </div>
                <div>
                    <div class="title">대상 지점</div>
                    <H2 id="target_point"> 미 지정</H2>
                </div>

                <div hidden>
                    <div class="title">Xsls Upload</div>
                    <form method="post" enctype="multipart/form-data" id="fileUploadForms">
                        {% csrf_token %}
                        <input type="file" name="myfiles" multiple>
                        <button type="submit" class="btn btn-light" id="btnSubmits">
                            <i class="fas fa-download mr-8"></i>Upload
                        </button>
                    </form>
                </div>

            </div>
        </div>
        {% include "backend/new_datepicker.html" %}
        <div class="pd-20 debug">
            <div style="display: flex; flex-direction: row; justify-content: space-around; ">
                {% csrf_token %}
                <form method="post" enctype="multipart/form-data" id="fileUploadForm">
                    <label>측정 DATA 등록</label>
                    {% csrf_token %}
                    <input type="file" name="myfile">
                    <button type="submit" class="btn btn-light" id="btnSubmit">
                        <i class="fas fa-download mr-8"></i>모델 불러오기
                    </button>
                </form>
                <button type="button" type='submit' class="btn btn-light" onclick="file_download()" download>
                    <i class="fas fa-chart-line mr-8"></i>샘플 다운로드
                </button>
                {#                <form method="get" action="{% url "file_download" %}">#}
                {#   <button type="submit">Download!</button>#}
                {#</form>#}
                <button type="button" class="btn btn-light" onclick="pridict()">
                    <i class="fas fa-chart-line mr-8"></i>예측하기
                </button>
            </div>


        </div>
        <!--
        <div class="pd-20 debug">
            <div class="title">현재 사용중인 모델</div>
            {% if file_list_zip %}재
                <div class="modelname">{{ file_list_zip }}</div>
            {% else %}
                <div class="modelname">현재 모델이 존재하지 않습니다</div>
            {% endif %}
        </div>
        -->
        <!--
        <div class="pd-20 debug">
            <div class="title">기능</div>
            <div class="row">
                <div class="col text-center">
                    <button type="button" class="btn btn-light">
                        <i class="fas fa-theater-masks mr-8"></i>학습하기
                    </button>
                </div>
                <div class="col text-center">
                    <button type="button" onclick="file_download()" class="btn btn-light">
                        <i class="fas fa-upload mr-8"></i>모델 저장
                    </button>
                </div>

                <div class="col text-center">
                    <form method="post" enctype="multipart/form-data" id="fileUploadForm">

                        <input type="file" name="myfile">
                        <button type="submit" class="btn btn-light" id="btnSubmit">
                            <i class="fas fa-download mr-8"></i>모델 불러오기
                        </button>
                    </form>
                </div>

                <div class="col text-center">

                </div>
                <div class="col text-center">
                    <button type="button" class="btn btn-light">
                        <i class="fas fa-chart-line mr-8"></i>예측하기
                    </button>
                </div>
            </div>
        </div>
    -->
        {% include "backend/chart.html" %}


    </div>
{% endblock %}


{% block javascript %}
    <script>
        $('#loading').hide();
        <!-- model 별 위치를 위한 map setting-->
        var options = { //지도를 생성할 때 필요한 기본 옵션
            center: new kakao.maps.LatLng(36.5, 127.5), //지도의 중심좌표.
            level: 10//지도의 레벨(확대, 축소 정도)
        };
        var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

        var model_activate = ''

        function pridict() {
            if ($('#column_list').children().length == 1) {
                alert("Model 선택은 필수사항입니다");
            } else if ($('#start-train').val() == "") {
                alert("날짜 선택은 필수사항입니다");
            } else {
                $('#loading').show();
                $.ajax({
                    url: "{% url "predict" %}",
                    data: {
                        csrfmiddlewaretoken: $("#csrf_token").val(),
                        "key": $('#column_list').val(),
                        "model": model_activate,
                        "start_date": formatDate(_startTrain),
                        "end_date": formatDate(_endTrain),
                        "predict_start_date": formatDate(_startPredict),
                        "predict_end_date": formatDate(_endPredict)
                    },
                    type: "POST",
                    dataType: "json"
                }).done(function (data) {
                    let water_arr = Array();
                    let graph_arr = Array();

                    $('#loading').hide();
                    // chart_data
                    _predictWater.data.datasets[0].data = data.predict_water;
                    // chart_column
                    _predictWater.options.title.text = data.column;
                    // chart_labels
                    for (let i = 7; i < 10; i++) {
                        tmp_date = new Date();
                        tmp_date.setDate(_startTrain.getDate() + i);
                        let A = formatDate(tmp_date);
                        water_arr.push(A)

                    }
                    _predictWater.data.labels = water_arr
                    _predictWater.update();
                    for (let i = 0; i < 10; i++) {
                        tmp_date = new Date();
                        tmp_date.setDate(_startTrain.getDate() + i);
                        let A = formatDate(tmp_date);
                        graph_arr.push(A)

                    }
                    _predictGraph.data.labels = graph_arr
                    _predictGraph.data.datasets[0].data = data.predict_cahrt.origin;
                    _predictGraph.data.datasets[1].data = data.predict_cahrt.predict;
                    _predictGraph.data.datasets[2].data = data.predict_cahrt.origin_2;
                    _predictGraph.update();

                })
            }

        };

        function select_model(param) {

            $.ajax({
                url: "{% url "call_model" %}",
                data: {
                    csrfmiddlewaretoken: $("#csrf_token").val(),
                    "param": param
                },
                type: "POST",
                dataType: "json"
            }).done(function (data) {
                model_activate = param
                let map_info = data.web_info.map_info
                $('#column_list').empty();
                for (let i = 0; i < (data.web_info.column).length; i++) {
                    let col_dict = data.web_info.column
                    for (let key in col_dict[i]) {
                        $('#column_list').append("<option value=" + key + ">" + col_dict[i][key] + "</option>")
                    }
                }
                $('#target_point').text(data.web_info.target_point);
                options = { //지도를 생성할 때 필요한 기본 옵션
                    center: new kakao.maps.LatLng(data.x, data.y), //지도의 중심좌표.
                    level: 10//지도의 레벨(확대, 축소 정도)
                };
                // 모델별 지도 중심위치 지정
                map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
                load_map_data(map_info);
            })
        };

        $("#btnSubmit").click(function (event) {
            event.preventDefault();
            var form = $('#fileUploadForm')[0];

            var data = new FormData(form);
            data.append('start_date', $('#start-predict').val());
            data.append('end_date', $('#end-predict').val());
            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "{% url "file_upload" %}",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {
                    alert("complete");
                },
                error: function (e) {
                    console.log("ERROR : ", e);
                    alert("fail");
                }
            });

        });
        $("#btnSubmits").click(function (event) {
            event.preventDefault();
            var form = $('#fileUploadForms')[0];
            var data = new FormData(form);

            alert('data', data);
            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "{% url "multi_file_upload" %}",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {
                    alert("complete");
                },
                error: function (e) {
                    console.log("ERROR : ", e);
                    alert("fail");
                }
            });

        });


        function file_download() {
            /*
            $.ajax({
                url: "











            {% url "file_download" %}", // 클라이언트가 요청을 보낼 서버의 URL 주소
                data: {csrfmiddlewaretoken: $("#csrf_token").val()},
                type: "GET"
            }).done(function () {
                alert(333);
            })
            */
            var url = "../../../media/xlsx_sample.xlsx";
            location.href = url;
        }


    </script>
{% endblock %}
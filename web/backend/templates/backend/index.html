{% extends "backend/layout/base.html" %}
{% load static %}
{% block content %}
    <div class="container pt-25 debug">

        <div class="text-center debug">
            <div>
                <span class="main-title">TOC 예측시스템</span>
            </div>
            <div>
                <span class="main-title-sub">total organic carbon predict system</span>
            </div>
        </div>


        <div class="pd-20 debug" style="display: flex">
            <div style="margin-right: 30%;">
                <div class="title">입력 파라미터</div>
                <button type="button" class="btn btn-light">
                    <i class="fas fa-download mr-8"></i>Json 불러오기
                </button>
            </div>
            <div style="margin-right: 0%;">
                <div class="title">Xsls Upload</div>
                <form method="post" enctype="multipart/form-data" id="fileUploadForms">
                    {% csrf_token %}
                    <input type="file" name="myfiles" multiple>
                    <button type="submit" class="btn btn-light" id="btnSubmits">
                        <i class="fas fa-download mr-8"></i>Upload
                    </button>
                </form>
            </div>

        </div>

        <div style="display: flex;">
            <div class="pd-20 debug" style="width: 45%;">
                <div class="title">입력 하기</div>
                <textarea id="json_area" class="autosize"
                          style="width: 100%;border: 0 none white; overflow:visible; outline: none; background-color: #D0D0D0;"></textarea>
            </div>

            <div class="pd-20 debug" style="width: 10%;">
                <button class="btn btn-light" onclick="json_convert()"
                        style="margin-top: 100%; border: solid 2px black; background-color: #d3e4ec;">Convert
                </button>
            </div>

            <div class="pd-20 debug" style="width: 45%;">
                <div class="title" id="hljs_json">입력 미리보기</div>
                <pre id="json_pre"><code class="hljs json" id="json_value">{
  "gain": {
    "data_dir": "data_after",
    "data_file": [
      [
        "가평_2016.xlsx",
        "가평_2017.xlsx",
        "가평_2018.xlsx",
        "가평_2019.xlsx"
      ],
      [
        "의암호_2016.xlsx",
        "의암호_2017.xlsx",
        "의암호_2018.xlsx",
        "의암호_2019.xlsx"
      ]
    ],
    "max_epochs": 100,
    "input_width": 120,
    "label_width": 120,
    "shift": 0,
    "use_train": true,
    "batch_size": 120,
    "miss_pattern": true,
    "miss_rate": 0.15,
    "fill_no": 3,
    "debug": true
  },
  "rnn": {
    "max_epochs": 100,
    "target_col": "not use",
    "use_train": true,
    "batch_size": 0,
    "fill_no": 0
  }
}
                </code></pre>
            </div>
        </div>
        {% include "backend/sample_map.html" %}

        {% include "backend/sample_datepicker.html" %}

        <div class="pd-20 debug">
            <div class="title">현재 사용중인 모델</div>
            {% if file_list_zip %}
                <div class="modelname">{{ file_list_zip }}</div>
            {% else %}
                <div class="modelname">현재 모델이 존재하지 않습니다</div>
            {% endif %}
        </div>

        <div class="pd-20 debug">
            <div class="title">기능</div>
            <div class="row">
                <div class="col text-center">
                    <button type="button" class="btn btn-light">
                        <i class="fas fa-theater-masks mr-8"></i>학습하기
                    </button>
                </div>
                <div class="col text-center">
                    <!-- ################################ -->
                    {% csrf_token %}
                    <button type="button" onclick="file_download()" class="btn btn-light">
                        <i class="fas fa-upload mr-8"></i>모델 저장
                    </button>
                    <!-- ################################ -->
                </div>

                <div class="col text-center">
                    <form method="post" enctype="multipart/form-data" id="fileUploadForm">
                        {% csrf_token %}
                        <input type="file" name="myfile">
                        <button type="submit" class="btn btn-light" id="btnSubmit">
                            <i class="fas fa-download mr-8"></i>모델 불러오기
                        </button>
                    </form>
                </div>

                <div class="col text-center">

                </div>
                <div class="col text-center">
                    <button type="button" class="btn btn-light">
                        <i class="fas fa-chart-line mr-8"></i>예측하기
                    </button>
                </div>
            </div>
        </div>

        <div class="pd-20 debug">
            <div class="title">예측 그래프</div>
            <canvas id="predictGraph" width="400" height="100"></canvas>
        </div>

        <div class="pd-20 debug">
            <div class="title">예측 강우량 및 기온</div>
            <canvas id="predictData" width="400" height="100"></canvas>
        </div>

        <div class="pd-20 debug">
            <div class="title">예측 수질</div>
            <canvas id="predictWater" width="400" height="100"></canvas>
        </div>
    </div>
{% endblock %}


{% block javascript %}
    <script>
        $("textarea.autosize").on('keydown keyup', function () {
            $(this).height(1).height($(this).prop('scrollHeight') + 12);
        });

        function json_convert() {
            $('#json_pre').remove();
            let json_area = $('#json_area').val();
            $('#hljs_json').append("<pre id=\"json_pre\"><code class=\"hljs json\" id=\"json_value\">" + json_area + "</code></pre>")
            hljs.initHighlighting.called = false;
            hljs.initHighlighting();
        }

        $("#btnSubmit").click(function (event) {
            event.preventDefault();
            var form = $('#fileUploadForm')[0];
            var data = new FormData(form);
            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "{% url "file_upload" %}",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {
                    alert("complete");
                },
                error: function (e) {
                    console.log("ERROR : ", e);
                    alert("fail");
                }
            });

        });
        $("#btnSubmits").click(function (event) {
            event.preventDefault();
            var form = $('#fileUploadForms')[0];
            var data = new FormData(form);

            alert('data', data);
            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "{% url "multi_file_upload" %}",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {
                    alert("complete");
                },
                error: function (e) {
                    console.log("ERROR : ", e);
                    alert("fail");
                }
            });

        });


        function file_download() {
            $.ajax({
                url: "{% url "file_download" %}", // 클라이언트가 요청을 보낼 서버의 URL 주소
                data: {"csrfmiddlewaretoken": $("input[name='csrfmiddlewaretoken']").val()},                // HTTP 요청과 함께 서버로 보낼 데이터
                type: "POST",                             // HTTP 요청 방식(GET, POST)
                dataType: "json"                         // 서버에서 보내줄 데이터의 타입
            }).done(function () {
                alert(333);
            })
        }

        var predictGraph = document.getElementById('predictGraph');
        var _predictGraph = new Chart(predictGraph, {
            type: 'line',
            data: {
                labels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                datasets: [
                    {
                        label: '테스트',
                        data: [0, 0, 2, 0, 1.8, 0, 2, 0, 2, 0, 0, 0, 2.3, 2.4, 2.7, 0],
                        borderColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        lineTension: 0,
                    },
                    {
                        label: '예측',
                        data: [1, -1, 1, 0, 1.5, 0, 1.8, 0, 1.7, 0.3, 0.2, 0.3, 2.1, 2.2, 2.3, 0.1],
                        borderColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        lineTension: 0,
                    },
                ]
            }
        });

        var predictData = document.getElementById('predictData');
        var _predictData = new Chart(predictData, {
            type: 'bar',
            data: {
                labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                datasets: [
                    {
                        label: '강우량',
                        data: [50, 50, 55, 60, 100, 140, 260, 300, 220, 120, 100, 50],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        type: 'bar',
                    },
                    {
                        label: '기온',
                        data: [150, 155, 180, 250, 280, 300, 340, 350, 320, 280, 210, 160],
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                    },
                ]
            }
        });

        var predictWater = document.getElementById('predictWater');
        var _predictWater = new Chart(predictWater, {
            type: 'bar',
            data: {
                labels: ['1일', '2일', '3일', '4일', '5일'],
                datasets: [
                    {
                        label: '좋음 (4.0 이하)',
                        data: [3, 2, 3, 0, 0],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    },
                    {
                        label: '나쁨 (5.0 이상)',
                        data: [0, 0, 0, 8, 9],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: '수질 기준 (BOD mg/l)'
                }
            }
        });
    </script>
{% endblock %}